<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¯¹å¤–æ±‰è¯­æ•™å­¦å¹³å°</title>
<style>
:root{--bg:#f3f9ff;--card:#fff;--accent:#3b82f6;--muted:#374151;--danger:#ef4444}
body{font-family:"Microsoft YaHei",Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
.wrap{max-width:1100px;margin:0 auto}
.card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
h1,h2{margin:0 0 10px}
.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.hidden{display:none}
.options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.opt{padding:12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;color:#000;cursor:pointer}
.opt.correct{background:#d1fae5;border-color:#10b981}
.opt.wrong{background:#fee2e2;border-color:#ef4444}
.word-big{font-size:36px;margin:10px 0}
input,select,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d1d5db;color:#000}
button{cursor:pointer;background:var(--accent);color:#fff;border:none}
.btn-danger{background:var(--danger)}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:8px;border:1px solid #d1d5db;text-align:left}
.level-badge{display:inline-block;padding:4px 8px;background:#eef2ff;border-radius:6px;margin-right:6px}
.flex{display:flex;gap:12px;align-items:center}
.search{margin-bottom:8px}
.small{font-size:13px;color:var(--muted)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn-plain{background:#e5e7eb;color:#000}
.selected{outline:2px solid #3b82f6}
</style>
</head>
<body>
<div class="wrap">
  <!-- ç™»å½•å¡ -->
  <div class="card" id="loginCard">
    <h1>å¯¹å¤–æ±‰è¯­æ•™å­¦å¹³å°</h1>
    <div class="row">
      <div style="flex:1">
        <label>å§“å</label><br>
        <input id="studentName" placeholder="ä¾‹å¦‚ï¼šKota">
      </div>
      <div style="width:120px">
        <label>å¹´çº§</label><br>
        <select id="gradeSelect">
          <option value="6">6å¹´çº§</option>
          <option value="7">7å¹´çº§</option>
          <option value="8">8å¹´çº§</option>
          <option value="9">9å¹´çº§</option>
        </select>
      </div>
      <div style="width:160px;margin-top:18px">
        <button id="loginBtn">ç™»å…¥</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <label>è§’è‰²</label><br>
      <select id="roleSelect">
        <option value="student">å­¦ç”Ÿ</option>
        <option value="teacher">æ•™å¸ˆ</option>
      </select>
    </div>
    <div id="teacherPasswordDiv" class="hidden" style="margin-top:10px">
      <label>æ•™å¸ˆå¯†ç ï¼š</label>
      <input id="teacherPassword" type="password" placeholder="è¯·è¾“å…¥æ•™å¸ˆå¯†ç ">
    </div>
    <p class="small" style="margin-top:8px">æ•™å¸ˆæ¨¡å¼å¯æŸ¥çœ‹å­¦ç”Ÿæˆç»©ï¼ˆæŒ‰å¹´çº§ + å…³å¡ç­›é€‰ï¼‰ã€‚</p>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div class="card hidden" id="mainCard">
    <div class="row" style="justify-content:space-between">
      <div>
        <strong id="welcome"></strong> (<span id="roleTag"></span>) <span id="studentGrade" class="small"></span>
      </div>
      <div class="toolbar">
        <button id="logoutBtn" class="btn-danger">ç™»å‡º</button>
        <button id="teacherModeBtn" class="hidden btn-plain">æ•™å¸ˆæ¨¡å¼</button>
      </div>
    </div>

    <!-- å­¦ç”Ÿæ§åˆ¶ -->
    <div class="row" style="margin-top:12px" id="studentControls">
      <label>é¢˜å‹ï¼š</label>
      <select id="gameType">
        <option value="mc">çœ‹è¯é€‰ä¹‰</option>
        <option value="typing">æ‹¼å†™/è¾“å…¥</option>
        <option value="listen">å¬å†™</option>
        <option value="match">é…å¯¹</option>
        <option value="pair">è¿è¿çœ‹</option>
      </select>
      <label>å…³å¡ï¼š</label>
      <select id="levelSelect"></select>
      <button id="startGameBtn">å¼€å§‹é—¯å…³</button>
    </div>

    <!-- æ¸¸æˆåŒºåŸŸ -->
    <div id="gameArea" style="margin-top:12px"></div>

    <div id="resultArea" class="hidden">
      <h3>æœ¬æ¬¡å¾—åˆ†ï¼š<span id="sessionScore"></span></h3>
      <div class="row">
        <button id="retryBtn">é‡ç©æœ¬å…³</button>
        <button id="saveAndExitBtn" class="btn-plain">ä¿å­˜å¹¶é€€å‡º</button>
      </div>
    </div>

    <!-- æ•™å¸ˆåå°ï¼ˆä»…æ•™å¸ˆå¯è§ï¼‰ -->
    <div id="teacherArea" class="hidden" style="margin-top:12px">
      <div class="row">
        <label>ç­›é€‰å¹´çº§ï¼š</label>
        <select id="filterGrade">
          <option value="">å…¨éƒ¨</option>
          <option value="6">6å¹´çº§</option>
          <option value="7">7å¹´çº§</option>
          <option value="8">8å¹´çº§</option>
          <option value="9">9å¹´çº§</option>
        </select>
        <label>ç­›é€‰å…³å¡ï¼š</label>
        <select id="filterLevel"><option value="">å…¨éƒ¨</option></select>
        <label>æœç´¢ï¼š</label>
        <input id="filterName" placeholder="å§“å">
        <button id="refreshScores" class="btn-plain">åˆ·æ–°æˆç»©</button>
        <button id="exportCsv" class="btn-plain">å¯¼å‡º CSV</button>
        <button id="clearAll" class="btn-danger">æ¸…ç©ºæ‰€æœ‰æˆç»©</button>
      </div>
      <table class="table" id="scoreTable" style="margin-top:8px">
        <thead><tr><th>å§“å</th><th>å¹´çº§</th><th>å…³å¡</th><th>é¢˜å‹</th><th>åˆ†æ•°</th><th>æ—¶é—´</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ---------- é…ç½® ---------- */
const TEACHER_PASSWORD = 'NK0811'; // æ•™å¸ˆå¯†ç 
// è¯·æŠŠ correct.mp3 å’Œ wrong.mp3 æ”¾åœ¨åŒä¸€ç›®å½•ï¼ˆæˆ–ä¿®æ”¹è·¯å¾„ï¼‰
const correctSound = new Audio('correct.mp3');
const wrongSound = new Audio('wrong.mp3');

/* ---------- æ•°æ®ï¼ˆç¤ºä¾‹å…³å¡ï¼‰ ---------- */
const LEVELS = [
  { name: 'PART1: å®¶äºº', words:[
    {ch:'çˆ¸çˆ¸',pin:'bÃ ba',en:'father'},
    {ch:'å¦ˆå¦ˆ',pin:'mÄma',en:'mother'},
    {ch:'å“¥å“¥',pin:'gÄ“ge',en:'older brother'},
    {ch:'å§å§',pin:'jiÄ›jie',en:'older sister'},
    {ch:'å¼Ÿå¼Ÿ',pin:'dÃ¬di',en:'younger brother'},
    {ch:'å¦¹å¦¹',pin:'mÃ¨imei',en:'younger sister'}
  ]},
  { name: 'PART2: äº²æˆš', words:[
    {ch:'çˆ·çˆ·',pin:'yÃ©ye',en:'grandfather'},
    {ch:'å¥¶å¥¶',pin:'nÇinai',en:'grandmother'},
    {ch:'å”å”',pin:'shÅ«shu',en:'uncle'},
    {ch:'å§‘å§‘',pin:'gÅ«gu',en:'aunt'}
  ]}
];

/* ---------- DOM ---------- */
const loginCard = document.getElementById('loginCard');
const mainCard = document.getElementById('mainCard');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const studentNameEl = document.getElementById('studentName');
const gradeSelect = document.getElementById('gradeSelect');
const roleSelect = document.getElementById('roleSelect');
const teacherPasswordDiv = document.getElementById('teacherPasswordDiv');
const teacherPasswordInput = document.getElementById('teacherPassword');

const welcomeEl = document.getElementById('welcome');
const roleTag = document.getElementById('roleTag');
const studentGradeSpan = document.getElementById('studentGrade');

const studentControls = document.getElementById('studentControls');
const gameTypeEl = document.getElementById('gameType');
const levelSelectEl = document.getElementById('levelSelect');
const startGameBtn = document.getElementById('startGameBtn');
const gameArea = document.getElementById('gameArea');
const resultArea = document.getElementById('resultArea');
const sessionScoreEl = document.getElementById('sessionScore');
const retryBtn = document.getElementById('retryBtn');
const saveAndExitBtn = document.getElementById('saveAndExitBtn');

const teacherModeBtn = document.getElementById('teacherModeBtn');
const teacherArea = document.getElementById('teacherArea');
const filterGrade = document.getElementById('filterGrade');
const filterLevel = document.getElementById('filterLevel');
const filterName = document.getElementById('filterName');
const refreshScoresBtn = document.getElementById('refreshScores');
const scoreTableBody = document.querySelector('#scoreTable tbody');
const exportCsvBtn = document.getElementById('exportCsv');
const clearAllBtn = document.getElementById('clearAll');

/* ---------- çŠ¶æ€ ---------- */
let currentUser = null; // {name, role:'student'|'teacher', grade}
let currentSession = null; // {levelIndex, levelName, gameType, words, score, total, idx}

/* ---------- åˆå§‹åŒ–å…³å¡ä¸‹æ‹‰ ---------- */
function initLevels(){
  levelSelectEl.innerHTML = '';
  filterLevel.innerHTML = '<option value="">å…¨éƒ¨</option>';
  LEVELS.forEach((l,i)=>{
    const o = document.createElement('option'); o.value=i; o.textContent = l.name; levelSelectEl.appendChild(o);
    const f = document.createElement('option'); f.value=i; f.textContent = l.name; filterLevel.appendChild(f);
  });
}
initLevels();

/* ---------- ç™»å½•é€»è¾‘ ---------- */
roleSelect.onchange = ()=> teacherPasswordDiv.classList.toggle('hidden', roleSelect.value !== 'teacher');

loginBtn.onclick = ()=>{
  const name = studentNameEl.value.trim();
  const grade = gradeSelect.value;
  const role = roleSelect.value;
  if(!name){ alert('è¯·è¾“å…¥å§“å'); return; }
  if(role === 'teacher'){
    const pwd = teacherPasswordInput.value.trim();
    if(!pwd){ alert('è¯·è¾“å…¥æ•™å¸ˆå¯†ç '); return; }
    if(pwd !== TEACHER_PASSWORD){ alert('æ•™å¸ˆå¯†ç é”™è¯¯'); return; }
    currentUser = { name:'æ•™å¸ˆ', role:'teacher' };
    enterMain();
    // æ•™å¸ˆé»˜è®¤æ˜¾ç¤ºæ•™å¸ˆåŒº
    teacherArea.classList.remove('hidden');
    studentControls.classList.add('hidden');
    teacherModeBtn.classList.add('hidden');
    refreshScores();
    return;
  }
  currentUser = { name, role:'student', grade };
  enterMain();
  // å­¦ç”ŸUI
  studentControls.classList.remove('hidden');
  teacherModeBtn.classList.remove('hidden');
  teacherArea.classList.add('hidden');
  studentGradeSpan.textContent = `(${grade}å¹´çº§)`;
};

function enterMain(){
  loginCard.classList.add('hidden');
  mainCard.classList.remove('hidden');
  welcomeEl.textContent = currentUser.name;
  roleTag.textContent = currentUser.role === 'teacher' ? 'æ•™å¸ˆ' : 'å­¦ç”Ÿ';
}

/* ---------- ç™»å‡º ---------- */
logoutBtn.onclick = ()=>{
  location.reload();
};

/* ---------- å·¥å…·å‡½æ•° ---------- */
function shuffle(arr){ return arr.sort(()=> Math.random() - 0.5); }
function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function speak(text){ try { const u = new SpeechSynthesisUtterance(text); u.lang='zh-CN'; window.speechSynthesis.speak(u); } catch(e){} }

/* ---------- å¼€å§‹å…³å¡ ---------- */
startGameBtn.onclick = ()=>{
  if(!currentUser){ alert('è¯·å…ˆç™»å…¥'); return; }
  const lvlIndex = parseInt(levelSelectEl.value);
  const gameType = gameTypeEl.value;
  startSession(lvlIndex, gameType);
};

function startSession(levelIndex, gameType){
  const lvl = LEVELS[levelIndex];
  const words = shuffle([...lvl.words]);
  currentSession = {
    levelIndex,
    levelName: lvl.name,
    gameType,
    words: words.slice(0, Math.min(6, words.length)), // æ¯æ¬¡æœ€å¤š 6 é¢˜ï¼Œä¿è¯ä½“éªŒ
    score: 0,
    total: Math.min(6, words.length),
    idx: 0,
    timestamp: (new Date()).toLocaleString()
  };
  renderGame();
}

/* ---------- æ¸²æŸ“æ¸¸æˆï¼ˆäº”ç§é¢˜å‹ï¼‰ ---------- */
function renderGame(){
  gameArea.innerHTML = '';
  resultArea.classList.add('hidden');
  const g = currentSession.gameType;
  const words = currentSession.words;
  if(g === 'mc') renderMC(words);
  else if(g === 'typing') renderTyping(words);
  else if(g === 'listen') renderListen(words);
  else if(g === 'match') renderMatch(words);
  else if(g === 'pair') renderPair(words);
}

/* ----- çœ‹è¯é€‰ä¹‰ï¼ˆMCï¼‰ ----- */
function renderMC(words){
  let idx = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">çœ‹è¯é€‰ä¹‰ (${words.length} é¢˜)</div>`;
  gameArea.appendChild(box);

  function showQ(){
    box.querySelectorAll('.q').forEach(n=>n.remove());
    if(idx >= words.length){ finishAndSave(); return; }
    const w = words[idx];
    const q = document.createElement('div'); q.className='q';
    q.innerHTML = `<div class="word-big">${w.ch}</div><div class="muted">${w.pin}</div>`;
    // options
    const opts = [w.en];
    while(opts.length < 4){ const r = randomFrom(words).en; if(!opts.includes(r)) opts.push(r); }
    shuffle(opts);
    const optsBox = document.createElement('div'); optsBox.className='options';
    opts.forEach(option=>{
      const b = document.createElement('button'); b.className='opt'; b.textContent = option;
      b.onclick = ()=>{
        if(option === w.en){
          b.classList.add('correct');
          playCorrect(); currentSession.score++;
        } else {
          b.classList.add('wrong');
          playWrong();
          // highlight correct
          const right = [...optsBox.children].find(x=> x.textContent === w.en);
          if(right) right.classList.add('correct');
        }
        idx++; currentSession.idx = idx;
        setTimeout(showQ, 600);
      };
      optsBox.appendChild(b);
    });
    // speak button
    const speakBtn = document.createElement('button'); speakBtn.textContent = 'ğŸ”Š å‘éŸ³'; speakBtn.style.marginLeft='8px';
    speakBtn.onclick = ()=> speak(w.ch);
    q.appendChild(speakBtn);
    q.appendChild(optsBox);
    box.appendChild(q);
  }
  showQ();
}

/* ----- æ‹¼å†™/è¾“å…¥ï¼ˆTypingï¼‰ ----- */
function renderTyping(words){
  let idx = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">æ‹¼å†™/è¾“å…¥ (${words.length} é¢˜)</div>`;
  gameArea.appendChild(box);

  function showQ(){
    box.querySelectorAll('.q').forEach(n=>n.remove());
    if(idx >= words.length){ finishAndSave(); return; }
    const w = words[idx];
    const q = document.createElement('div'); q.className='q';
    q.innerHTML = `<div class="word-big">${w.ch}</div><div class="muted">${w.pin}</div>`;
    const inp = document.createElement('input'); inp.style.width='100%'; inp.placeholder='è¯·è¾“å…¥æ‹¼éŸ³æˆ–è‹±æ–‡ï¼Œå›è½¦æäº¤';
    inp.onkeydown = (e)=>{
      if(e.key === 'Enter'){
        const val = inp.value.trim().toLowerCase();
        if(val === w.pin.toLowerCase() || val === w.en.toLowerCase() || val === w.ch.toLowerCase()){
          playCorrect(); currentSession.score++;
        } else {
          playWrong();
          // show answer
          alert(`æ­£ç¡®ç­”æ¡ˆï¼š${w.ch} / ${w.pin} / ${w.en}`);
        }
        idx++; currentSession.idx = idx;
        setTimeout(showQ, 500);
      }
    };
    const speakBtn = document.createElement('button'); speakBtn.textContent='ğŸ”Š å‘éŸ³'; speakBtn.style.marginLeft='8px';
    speakBtn.onclick = ()=> speak(w.ch);
    q.appendChild(inp); q.appendChild(speakBtn);
    box.appendChild(q);
    inp.focus();
  }
  showQ();
}

/* ----- å¬å†™ï¼ˆListenï¼‰ ----- */
function renderListen(words){
  let idx = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">å¬å†™ (${words.length} é¢˜)</div>`;
  gameArea.appendChild(box);

  function showQ(){
    box.querySelectorAll('.q').forEach(n=>n.remove());
    if(idx >= words.length){ finishAndSave(); return; }
    const w = words[idx];
    const q = document.createElement('div'); q.className='q';
    const playBtn = document.createElement('button'); playBtn.textContent = 'ğŸ”Š æ’­æ”¾ (ç‚¹å‡»æ’­æ”¾å‘éŸ³)'; playBtn.onclick = ()=> speak(w.ch);
    q.appendChild(playBtn);
    const inp = document.createElement('input'); inp.style.width='100%'; inp.placeholder='è¾“å…¥ä½ å¬åˆ°çš„ä¸­æ–‡/è‹±æ–‡/æ‹¼éŸ³å¹¶å›è½¦';
    inp.onkeydown = (e)=>{
      if(e.key === 'Enter'){
        const val = inp.value.trim().toLowerCase();
        if(val === w.ch.toLowerCase() || val === w.en.toLowerCase() || val === w.pin.toLowerCase()){
          playCorrect(); currentSession.score++;
        } else {
          playWrong(); alert(`æ­£ç¡®ç­”æ¡ˆï¼š${w.ch} / ${w.pin} / ${w.en}`);
        }
        idx++; currentSession.idx = idx;
        setTimeout(showQ, 500);
      }
    };
    q.appendChild(inp);
    box.appendChild(q);
    inp.focus();
  }
  showQ();
}

/* ----- é…å¯¹ï¼ˆMatchï¼‰ ----- */
function renderMatch(words){
  currentSession.score = currentSession.score || 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">é…å¯¹ï¼šå…ˆç‚¹å‡»å·¦åˆ—ä¸­æ–‡ï¼Œå†ç‚¹å‡»å³åˆ—è‹±æ–‡</div>`;
  gameArea.appendChild(box);

  let selected = null;
  let correctPairs = 0;

  const left = words.map(w => ({ id: w.ch, text: w.ch }));
  const right = shuffle(words.map(w => ({ id: w.ch, text: w.en })));

  const leftBox = document.createElement('div'); leftBox.style.width='45%'; leftBox.style.display='inline-block';
  const rightBox = document.createElement('div'); rightBox.style.width='45%'; rightBox.style.display='inline-block';

  left.forEach(l=>{
    const b = document.createElement('button'); b.className='opt'; b.style.display='block'; b.style.width='100%'; b.style.marginBottom='6px';
    b.textContent = l.text;
    b.onclick = ()=>{
      // speak when click Chinese
      speak(l.text);
      selected = l;
      leftBox.querySelectorAll('button').forEach(x=> x.classList.remove('selected'));
      b.classList.add('selected');
    };
    leftBox.appendChild(b);
  });

  right.forEach(r=>{
    const b = document.createElement('button'); b.className='opt'; b.style.display='block'; b.style.width='100%'; b.style.marginBottom='6px';
    b.textContent = r.text;
    b.onclick = ()=>{
      if(!selected){ alert('è¯·å…ˆåœ¨å·¦åˆ—é€‰æ‹©ä¸­æ–‡'); return; }
      const correctEn = words.find(w=> w.ch === selected.id).en;
      if(r.text === correctEn){
        b.classList.add('correct'); playCorrect(); currentSession.score++; correctPairs++;
        // mark left correct
        Array.from(leftBox.children).forEach(btn=>{ if(btn.textContent === selected.text) btn.classList.add('correct'); });
      } else {
        b.classList.add('wrong'); playWrong();
      }
      // clear selection
      leftBox.querySelectorAll('button').forEach(x=> x.classList.remove('selected'));
      selected = null;
      if(correctPairs >= words.length) finishAndSave();
    };
    rightBox.appendChild(b);
  });

  box.appendChild(leftBox); box.appendChild(rightBox);
}

/* ----- è¿è¿çœ‹ï¼ˆPairï¼‰ ----- */
function renderPair(words){
  currentSession.score = currentSession.score || 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">è¿è¿çœ‹ï¼šç‚¹å‡»ä¸€é¡¹ï¼Œå†ç‚¹å‡»åŒ¹é…é¡¹</div>`;
  gameArea.appendChild(box);

  let first = null;
  let pairs = 0;
  const items = shuffle(words.flatMap(w => [{ type:'ch', key:w.ch, text:w.ch }, { type:'en', key:w.ch, text:w.en }]));
  const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(4,1fr)'; grid.style.gap='8px';
  items.forEach(it=>{
    const b = document.createElement('button'); b.className='opt'; b.textContent = it.text; b.style.minHeight='48px';
    b.onclick = ()=>{
      // if clicking Chinese word, speak immediately
      if(it.type === 'ch') speak(it.text);
      if(!first){
        first = { el: b, item: it };
        b.classList.add('selected');
        return;
      }
      // second click
      if(first.item.key === it.key && first.item.type !== it.type){
        // match OK
        playCorrect(); currentSession.score++; pairs++;
        first.el.classList.add('correct'); b.classList.add('correct');
        // hide matched after short delay
        setTimeout(()=>{ first.el.style.visibility='hidden'; b.style.visibility='hidden'; }, 300);
      } else {
        playWrong();
        first.el.classList.add('wrong'); b.classList.add('wrong');
        setTimeout(()=>{ first.el.classList.remove('wrong','selected'); b.classList.remove('wrong'); }, 400);
      }
      first.el.classList.remove('selected');
      first = null;
      if(pairs >= words.length) finishAndSave();
    };
    grid.appendChild(b);
  });
  box.appendChild(grid);
}

/* ---------- å®Œæˆå¹¶ä¿å­˜æˆç»© ---------- */
function finishAndSave(){
  // show result
  sessionScoreEl.textContent = `${currentSession.score} / ${currentSession.total}`;
  resultArea.classList.remove('hidden');

  // ä¿å­˜æˆç»©åˆ° localStorageï¼ˆä»…å½“å­¦ç”Ÿåœ¨ç©ï¼‰
  if(currentUser && currentUser.role === 'student'){
    const key = 'cf_scores_v2';
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.push({
      name: currentUser.name,
      grade: currentUser.grade,
      levelIndex: currentSession.levelIndex,
      levelName: currentSession.levelName,
      gameType: currentSession.gameType,
      score: `${currentSession.score}/${currentSession.total}`,
      time: currentSession.timestamp || (new Date()).toLocaleString()
    });
    localStorage.setItem(key, JSON.stringify(arr));
  }
}

/* ---------- æ’­æ”¾ç­”å¯¹/ç­”é”™å£°éŸ³ï¼ˆä½¿ç”¨æ­£ç¡®æ–‡ä»¶åï¼‰ ---------- */
function playCorrect(){ try{ correctSound.currentTime = 0; correctSound.play(); }catch(e){} }
function playWrong(){ try{ wrongSound.currentTime = 0; wrongSound.play(); }catch(e){} }

/* ---------- é‡ç© / ä¿å­˜å¹¶é€€å‡º ---------- */
retryBtn.onclick = ()=> {
  if(currentSession) startSession(currentSession.levelIndex, currentSession.gameType);
};
saveAndExitBtn.onclick = ()=> {
  // just show message and reset to main student screen
  alert('æœ¬æ¬¡æˆç»©å·²ä¿å­˜ã€‚');
  gameArea.innerHTML = '';
  resultArea.classList.add('hidden');
};

/* ---------- æ•™å¸ˆåå°åŠŸèƒ½ ---------- */
teacherModeBtn.onclick = ()=> {
  // toggle teacher area
  if(teacherArea.classList.contains('hidden')){
    teacherArea.classList.remove('hidden');
    studentControls.classList.add('hidden');
    teacherModeBtn.textContent = 'è¿”å›å­¦ç”Ÿç•Œé¢';
    refreshScores();
  } else {
    teacherArea.classList.add('hidden');
    studentControls.classList.remove('hidden');
    teacherModeBtn.textContent = 'æ•™å¸ˆæ¨¡å¼';
  }
};

refreshScoresBtn.onclick = refreshScores;
exportCsvBtn.onclick = exportCsv;
clearAllBtn.onclick = ()=> {
  if(!confirm('ç¡®è®¤è¦æ¸…ç©ºæ‰€æœ‰æˆç»©ï¼ˆlocalStorageï¼‰å—ï¼Ÿ')) return;
  localStorage.removeItem('cf_scores_v2');
  refreshScores();
};

function refreshScores(){
  const key = 'cf_scores_v2';
  const all = JSON.parse(localStorage.getItem(key) || '[]');
  const g = filterGrade.value;
  const li = filterLevel.value;
  const namef = (filterName.value || '').trim().toLowerCase();
  const filtered = all.filter(s=>{
    if(g && s.grade !== g) return false;
    if(li && parseInt(li) !== s.levelIndex) return false;
    if(namef && !s.name.toLowerCase().includes(namef)) return false;
    return true;
  });
  // render
  scoreTableBody.innerHTML = '';
  filtered.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.grade}</td><td>${s.levelName}</td><td>${s.gameType}</td><td>${s.score}</td><td>${s.time}</td>`;
    scoreTableBody.appendChild(tr);
  });
}

/* ---------- å¯¼å‡º CSV ---------- */
function exportCsv(){
  const key = 'cf_scores_v2';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  if(arr.length === 0){ alert('æš‚æ— æ•°æ®'); return; }
  const header = ['å§“å','å¹´çº§','å…³å¡Index','å…³å¡å','é¢˜å‹','åˆ†æ•°','æ—¶é—´'];
  const rows = arr.map(r=> [r.name, r.grade, r.levelIndex, r.levelName, r.gameType, r.score, r.time]);
  const csv = [header, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'scores.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ---------- é¡µé¢å¯è§æ—¶åˆ·æ–°ï¼ˆä¿è¯å¤šä¸ªçª—å£åŒæ­¥ï¼‰ ---------- */
window.addEventListener('storage', ()=> {
  if(!teacherArea.classList.contains('hidden')) refreshScores();
});

/* ---------- é¡µé¢è½½å…¥æ—¶ï¼ˆè‹¥å·²ç™»å…¥æ•°æ®ä¿ç•™ï¼‰ ---------- */
(function tryRestore(){
  // nothing to auto restore; login required
})();
</script>
</body>
</html>
